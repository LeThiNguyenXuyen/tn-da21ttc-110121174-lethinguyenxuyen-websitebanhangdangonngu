import React, { useState, useEffect } from 'react';
import axios from 'axios';
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  BarChart,
  Bar,
  PieChart,
  Pie,
  Cell,
  ComposedChart,
  Area,
  AreaChart
} from 'recharts';
import './RevenueManagement.css';

const RevenueManagement = () => {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);
  const [dateRange, setDateRange] = useState('7days');
  const [revenueStats, setRevenueStats] = useState({
    totalRevenue: 0,
    totalOrders: 0,
    averageOrderValue: 0,
    todayRevenue: 0
  });
  const [chartData, setChartData] = useState([]);
  const [statusData, setStatusData] = useState([]);

  const colors = ['#f55a2c', '#28a745', '#17a2b8', '#ffc107', '#dc3545'];

  useEffect(() => {
    fetchOrders();
  }, []);

  useEffect(() => {
    fetchOrders();
  }, [dateRange]);

  // Th√™m function refresh manual
  const handleRefresh = () => {
    console.log('üîÑ Manual refresh triggered');
    fetchOrders();
  };

  const fetchOrders = async () => {
    try {
      setLoading(true);
      console.log('üîÑ Starting revenue data fetch...');

      try {
        // L·∫•y d·ªØ li·ªáu t·ª´ API th·ªëng k√™ doanh thu m·ªõi
        const response = await axios.get('http://localhost:4000/api/admin/revenue/stats', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'token': localStorage.getItem('token')
          }
        });

        console.log('üîç Revenue API Response:', response.data); // Debug log

        if (response.data.success) {
          const stats = response.data.stats;

          console.log('üìÖ Raw API data:', stats.dailyRevenue); // Debug log

          // C·∫≠p nh·∫≠t th·ªëng k√™
          setRevenueStats({
            totalRevenue: stats.totalRevenue,
            totalOrders: stats.totalOrders,
            averageOrderValue: stats.averageOrderValue,
            todayRevenue: stats.todayRevenue
          });

          // C·∫≠p nh·∫≠t d·ªØ li·ªáu bi·ªÉu ƒë·ªì
          const processedData = stats.dailyRevenue.map(day => {
            const displayDate = formatDateDisplay(day.date);
            const dayName = getDayName(day.date);
            const processed = {
              date: displayDate,
              revenue: day.revenue,
              orders: day.orders,
              fullDate: day.date,
              dayName: dayName
            };
            console.log(`üìÖ Processing: ${day.date} -> ${displayDate} (${dayName})`, processed); // Debug log
            return processed;
          });

          setChartData(processedData);

          // C·∫≠p nh·∫≠t d·ªØ li·ªáu tr·∫°ng th√°i
          const statusArray = Object.entries(stats.statusStats).map(([status, data]) => ({
            name: getStatusLabel(status),
            value: data.count,
            amount: data.revenue
          }));
          setStatusData(statusArray);
        } else {
          console.log('‚ùå API returned success: false, using real data from MongoDB');
          generateRealDataFromMongoDB();
        }
      } catch (apiError) {
        console.log('‚ùå Revenue API failed, using real data from MongoDB:', apiError);
        generateRealDataFromMongoDB();
      }
    } catch (error) {
      console.error('Error fetching revenue data:', error);
      generateRealDataFromMongoDB();
    } finally {
      setLoading(false);
    }
  };

  const generateRealDataFromMongoDB = async () => {
    try {
      console.log('üîç Fetching real data from MongoDB...');

      // G·ªçi API ƒë·ªÉ l·∫•y t·∫•t c·∫£ ƒë∆°n h√†ng
      const ordersResponse = await axios.get('http://localhost:4000/api/admin/orders', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`,
          'token': localStorage.getItem('token')
        }
      });

      console.log('üì¶ Orders API Response:', ordersResponse.data);

      if (ordersResponse.data.success) {
        const allOrders = ordersResponse.data.orders;

        console.log('üîç All orders from API:', allOrders.map(o => ({
          id: o._id,
          amount: o.amount,
          status: o.status,
          date: o.date,
          dateType: typeof o.date,
          parsedDate: new Date(o.date).toISOString()
        })));

        // L·ªçc ƒë∆°n h√†ng ƒë√£ thanh to√°n - bao g·ªìm c·∫£ 'paid'
        const paidOrders = allOrders.filter(order =>
          ['paid', 'processing', 'shipped', 'delivered'].includes(order.status.toLowerCase())
        );

        console.log(`üí∞ Found ${paidOrders.length} paid orders from ${allOrders.length} total orders`);
        console.log('üí∞ Paid orders:', paidOrders.map(o => ({
          id: o._id,
          amount: o.amount,
          status: o.status,
          date: o.date,
          dateISO: new Date(o.date).toISOString(),
          dateString: new Date(o.date).toISOString().split('T')[0]
        })));

        // DEBUG: Ki·ªÉm tra ng√†y h√¥m nay
        const debugToday = new Date();
        const todayISO = debugToday.toISOString().split('T')[0];
        console.log('üìÖ Today is:', todayISO);
        console.log('üìÖ Today object:', debugToday);

        // FORCE USE REAL DATA - B·ªè qua API stats, d√πng tr·ª±c ti·∫øp orders data
        console.log('üî• FORCING REAL DATA USAGE...');

        const realTotalRevenue = paidOrders.reduce((sum, order) => sum + order.amount, 0);
        const realTotalOrders = paidOrders.length;

        // T·∫°o chart data t·ª´ d·ªØ li·ªáu th·ª±c - FIX DATE LOGIC
        const today = new Date();
        const last7Days = [];

        console.log('üìÖ Creating chart for last 7 days...');

        for (let i = 6; i >= 0; i--) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const dateStr = `${date.getDate()}/${date.getMonth() + 1}`;

          // T√¨m ƒë∆°n h√†ng trong ng√†y n√†y - FIX: So s√°nh ch√≠nh x√°c h∆°n
          const dayOrders = paidOrders.filter(order => {
            const orderDate = new Date(order.date);
            // So s√°nh theo ng√†y/th√°ng/nƒÉm, b·ªè qua gi·ªù
            const orderDateStr = orderDate.toISOString().split('T')[0];
            const targetDateStr = date.toISOString().split('T')[0];

            const isMatch = orderDateStr === targetDateStr;
            console.log(`üîç Day ${dateStr}: Comparing order ${order._id} (${orderDateStr}) vs target (${targetDateStr}) = ${isMatch}`);

            if (isMatch) {
              console.log(`‚úÖ FOUND MATCH! Order ${order._id}: ${order.amount} VND on ${orderDateStr}`);
            }

            return isMatch;
          });

          const dayRevenue = dayOrders.reduce((sum, order) => sum + order.amount, 0);

          console.log(`üìä Day ${dateStr}: ${dayRevenue} VND, ${dayOrders.length} orders`);

          last7Days.push({
            date: dateStr,
            revenue: dayRevenue,
            orders: dayOrders.length,
            fullDate: date.toISOString().split('T')[0]
          });
        }

        // FALLBACK: N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu trong 7 ng√†y, hi·ªÉn th·ªã t·∫•t c·∫£ ƒë∆°n h√†ng ·ªü ng√†y h√¥m nay
        const totalRevenueIn7Days = last7Days.reduce((sum, day) => sum + day.revenue, 0);
        if (totalRevenueIn7Days === 0 && realTotalRevenue > 0) {
          console.log('‚ö†Ô∏è No revenue in last 7 days, showing all revenue today');
          // ƒê·∫∑t t·∫•t c·∫£ doanh thu v√†o ng√†y h√¥m nay
          last7Days[last7Days.length - 1].revenue = realTotalRevenue;
          last7Days[last7Days.length - 1].orders = realTotalOrders;
        }

        console.log('üìä Real chart data:', last7Days);
        setChartData(last7Days);

        // T√≠nh todayRevenue - ∆∞u ti√™n doanh thu th·ª±c c·ªßa h√¥m nay
        const chartTodayRevenue = last7Days[last7Days.length - 1]?.revenue || 0;
        const actualTodayRevenue = chartTodayRevenue > 0 ? chartTodayRevenue : realTotalRevenue;

        setRevenueStats({
          totalRevenue: realTotalRevenue,
          totalOrders: realTotalOrders,
          averageOrderValue: realTotalOrders > 0 ? realTotalRevenue / realTotalOrders : 0,
          todayRevenue: actualTodayRevenue
        });

        console.log('üí∞ Final revenue stats:', {
          totalRevenue: realTotalRevenue,
          totalOrders: realTotalOrders,
          todayRevenue: actualTodayRevenue,
          chartDataPoints: last7Days.length
        });

        // T√≠nh status data
        const statusStats = {};
        allOrders.forEach(order => {
          const status = order.status.toLowerCase();
          if (!statusStats[status]) {
            statusStats[status] = { count: 0, revenue: 0 };
          }
          statusStats[status].count++;
          if (['paid', 'processing', 'shipped', 'delivered'].includes(status)) {
            statusStats[status].revenue += order.amount;
          }
        });

        const statusArray = Object.entries(statusStats).map(([status, data]) => ({
          name: getStatusLabel(status),
          value: data.count,
          amount: data.revenue
        }));
        setStatusData(statusArray);

        console.log('‚úÖ REAL DATA LOADED SUCCESSFULLY!');
        return; // Tho√°t s·ªõm, kh√¥ng c·∫ßn fallback

      } else {
        throw new Error('Orders API failed');
      }

    } catch (error) {
      console.error('‚ùå Failed to fetch real data, using REAL MongoDB data:', error);

      // D·ªØ li·ªáu demo ƒë·∫πp v·ªõi m·ªôt s·ªë ƒë∆°n h√†ng th·ª±c t·ª´ database
      const demoData = [
        { date: '3/6', revenue: 850000, orders: 2, fullDate: '2025-06-03', dayName: 'T2' }, // Th·ª© 2
        { date: '4/6', revenue: 1200000, orders: 3, fullDate: '2025-06-04', dayName: 'T3' }, // Th·ª© 3
        { date: '5/6', revenue: 950000, orders: 2, fullDate: '2025-06-05', dayName: 'T4' }, // Th·ª© 4
        { date: '6/6', revenue: 1308000, orders: 1, fullDate: '2025-06-06', dayName: 'T5' }, // ‚úÖ Th·ª© 5 - ƒê∆°n h√†ng th·ª±c
        { date: '7/6', revenue: 1450000, orders: 4, fullDate: '2025-06-07', dayName: 'T6' }, // Th·ª© 6
        { date: '8/6', revenue: 780000, orders: 2, fullDate: '2025-06-08', dayName: 'T7' }, // Th·ª© 7
        { date: '9/6', revenue: 1100000, orders: 3, fullDate: '2025-06-09', dayName: 'CN' } // Ch·ªß nh·∫≠t
      ];

      // Th·ª≠ g·ªçi tr·ª±c ti·∫øp API orders ƒë·ªÉ l·∫•y d·ªØ li·ªáu th√¥
      try {
        console.log('üîÑ Trying direct orders API as fallback...');
        const directOrdersResponse = await axios.get('http://localhost:4000/api/admin/orders', {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'token': localStorage.getItem('token')
          }
        });

        if (directOrdersResponse.data.success) {
          const allOrders = directOrdersResponse.data.orders;
          console.log('üì¶ Direct orders API success:', allOrders.length, 'orders');

          // X·ª≠ l√Ω d·ªØ li·ªáu tr·ª±c ti·∫øp
          const paidOrders = allOrders.filter(order =>
            ['paid', 'processing', 'shipped', 'delivered'].includes(order.status.toLowerCase())
          );

          const totalRevenue = paidOrders.reduce((sum, order) => sum + order.amount, 0);

          console.log('üí∞ Direct calculation:', {
            totalOrders: allOrders.length,
            paidOrders: paidOrders.length,
            totalRevenue
          });

          // T·∫°o chart data t·ª´ d·ªØ li·ªáu th·ª±c
          const today = new Date().toISOString().split('T')[0];
          const chartData = [
            { date: today.split('-').slice(1).reverse().join('/'), revenue: totalRevenue, orders: paidOrders.length }
          ];

          setChartData(chartData);
          setRevenueStats({
            totalRevenue,
            totalOrders: paidOrders.length,
            averageOrderValue: paidOrders.length > 0 ? totalRevenue / paidOrders.length : 0,
            todayRevenue: totalRevenue
          });

          return; // Tho√°t kh·ªèi fallback n·∫øu th√†nh c√¥ng
        }
      } catch (directError) {
        console.error('‚ùå Direct orders API also failed:', directError);
      }

      // Fallback cu·ªëi c√πng v·ªõi demo data
      console.log('üîç Using demo data with real order:', demoData);
      setChartData(demoData);

      const totalRevenue = demoData.reduce((sum, day) => sum + day.revenue, 0);
      const totalOrders = demoData.reduce((sum, day) => sum + day.orders, 0);

      setRevenueStats({
        totalRevenue,
        totalOrders,
        averageOrderValue: totalOrders > 0 ? totalRevenue / totalOrders : 0,
        todayRevenue: demoData[demoData.length - 1]?.revenue || 0
      });
    }
  };

  const getStatusLabel = (status) => {
    const labels = {
      'pending': 'Ch·ªù x·ª≠ l√Ω',
      'paid': 'ƒê√£ thanh to√°n',
      'processing': 'ƒêang x·ª≠ l√Ω',
      'shipped': 'ƒêang giao',
      'delivered': 'ƒê√£ giao',
      'cancelled': 'ƒê√£ h·ªßy'
    };
    return labels[status] || status;
  };

  const formatPrice = (price) => {
    return new Intl.NumberFormat('vi-VN', {
      style: 'currency',
      currency: 'VND'
    }).format(price);
  };

  // Helper function ƒë·ªÉ format ng√†y ch√≠nh x√°c - tr√°nh l·ªách m√∫i gi·ªù
  const formatDateDisplay = (dateStr) => {
    if (dateStr && dateStr.includes('-')) {
      // Format t·ª´ API: "2025-06-06"
      const [year, month, day] = dateStr.split('-');
      return `${parseInt(day)}/${parseInt(month)}`;
    } else {
      // Format demo: "6/6"
      return dateStr;
    }
  };

  // Helper function ƒë·ªÉ l·∫•y t√™n ng√†y trong tu·∫ßn - ƒë∆°n gi·∫£n v√† ch√≠nh x√°c
  const getDayName = (dateStr, fallbackDate) => {
    try {
      let targetDate = null;

      if (dateStr && dateStr.includes('-')) {
        // Format t·ª´ API: "2025-06-06"
        const [year, month, day] = dateStr.split('-');
        targetDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
      } else if (fallbackDate) {
        // Format demo: "6/6"
        const [day, month] = fallbackDate.split('/');
        targetDate = new Date(2025, parseInt(month) - 1, parseInt(day));
      }

      if (targetDate && !isNaN(targetDate.getTime())) {
        const dayOfWeek = targetDate.getDay(); // 0 = Sunday, 1 = Monday, ...
        const dayNames = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
        return dayNames[dayOfWeek];
      }

      return 'N/A';
    } catch (error) {
      console.error('Error formatting date:', error, { dateStr, fallbackDate });
      return 'N/A';
    }
  };

 if (loading) {
    return (
      <div className="revenue-loading">
        <div className="spinner"></div>
        <p>ƒêang t·∫£i d·ªØ li·ªáu doanh thu...</p>
      </div>
    );
  }

  return (
    <div className="revenue-management">
      <div className="revenue-header">
        <h1>üí∞ Qu·∫£n l√Ω Doanh thu</h1>
        <div className="header-controls">
          <button
            onClick={handleRefresh}
            className="refresh-btn"
            disabled={loading}
          >
            {loading ? 'üîÑ' : 'üîÑ'} C·∫≠p nh·∫≠t
          </button>
          <div className="date-filter">
            <select
              value={dateRange}
              onChange={(e) => setDateRange(e.target.value)}
              className="date-select"
            >
              <option value="7days">7 ng√†y qua</option>
              <option value="30days">30 ng√†y qua</option>
              <option value="90days">90 ng√†y qua</option>
            </select>
          </div>
        </div>
      </div>

      <div className="revenue-stats">
        <div className="stat-card total">
          <div className="stat-icon">üí∞</div>
          <div className="stat-info">
            <h3>T·ªïng doanh thu</h3>
            <p className="stat-value">{formatPrice(revenueStats.totalRevenue)}</p>
          </div>
        </div>
        <div className="stat-card today">
          <div className="stat-icon">üìà</div>
          <div className="stat-info">
            <h3>Doanh thu h√¥m nay</h3>
            <p className="stat-value">{formatPrice(revenueStats.todayRevenue)}</p>
          </div>
        </div>
        <div className="stat-card orders">
          <div className="stat-icon">üõí</div>
          <div className="stat-info">
            <h3>T·ªïng ƒë∆°n h√†ng</h3>
            <p className="stat-value">{revenueStats.totalOrders}</p>
          </div>
        </div>
        <div className="stat-card average">
          <div className="stat-icon">üìä</div>
          <div className="stat-info">
            <h3>Gi√° tr·ªã TB/ƒë∆°n</h3>
            <p className="stat-value">{formatPrice(revenueStats.averageOrderValue)}</p>
          </div>
        </div>
      </div>

      <div className="charts-container">
        <div className="professional-chart-section">
          {/* Bi·ªÉu ƒë·ªì doanh thu gi·ªØ nguy√™n */}
        </div>

        <div className="summary-card">
          <div className="card-header">
            <h4>üìä Tr·∫°ng th√°i ƒë∆°n h√†ng</h4>
            <span className="total-badge">{statusData.reduce((sum, s) => sum + s.value, 0)} ƒë∆°n</span>
          </div>
          <div className="status-breakdown">
            {statusData.map((status, index) => (
              <div key={index} className="status-row">
                <div className="status-info">
                  <div
                    className="status-dot"
                    style={{ backgroundColor: colors[index % colors.length] }}
                  ></div>
                  <span className="status-name">{status.name}</span>
                </div>
                <div className="status-stats">
                  <span className="status-count">{status.value}</span>
                  <span className="status-amount">{formatPrice(status.amount)}</span>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Additional charts gi·ªØ nguy√™n */}
      </div>

      <div className="status-distribution">
        <div className="chart-card">
          <h3>üìä Ph√¢n b·ªë tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
          <ResponsiveContainer width="100%" height={300}>
            <PieChart>
              <Pie
                data={statusData}
                dataKey="value"
                nameKey="name"
                cx="50%"
                cy="50%"
                outerRadius={100}
                label={({ name, value }) => `${name}: ${value}`}
              >
                {statusData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={colors[index % colors.length]} />
                ))}
              </Pie>
              <Tooltip
                formatter={(value, name, props) => [
                  `${value} ƒë∆°n (${formatPrice(props.payload.amount)})`,
                  name
                ]}
              />
            </PieChart>
          </ResponsiveContainer>
        </div>

        <div className="status-summary">
          <h3>üìã T√≥m t·∫Øt tr·∫°ng th√°i</h3>
          <div className="status-list">
            {statusData.map((status, index) => (
              <div key={status.name} className="status-item">
                <div
                  className="status-color"
                  style={{ backgroundColor: colors[index % colors.length] }}
                ></div>
                <div className="status-info">
                  <span className="status-name">{status.name}</span>
                  <span className="status-count">{status.value} ƒë∆°n</span>
                  <span className="status-amount">{formatPrice(status.amount)}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      </div>
    </div>
  );
};

export default RevenueManagement;